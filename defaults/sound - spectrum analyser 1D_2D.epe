{
  "name": "sound - spectrum analyser 1D/2D",
  "id": "LovYqewqXjNBhdGYL",
  "sources": {
    "main": "/*\n  Sound - spectrum analyser 1D/2D\n  \n  Output demo: https://youtu.be/sZIZiAt9l4o\n  (You can connect multiple Pixelblaze to a single sensor expansion board.)\n  \n  This pattern uses the sensor expansion board and a 2D LED matrix. It displays\n  a spectrum analyser based on the frequency data from the microphone. This is a\n  real time graph where the low frequencies are plotted on the left hand side,\n  and higher frequencies are on the right.\n  \n  This pattern is meant to be displayed on an LED matrix or other 2D surface \n  defined in the Mapper tab. Using the computer graphics convention, (x, y) = \n  (0, 0) is the top left (positive y advances downwards). You will need to set\n  the 'width' variable below to match the width of your matrix.\n  \n  There's also a 1D fallback and a spectrum simulator used when the sensor board\n  is not detected.\n  \n  Generously contributed by ChrisNZ (Chris) from the Pixelblaze forums.\n    https://forum.electromage.com/u/chrisnz\n*/\n\n// Set this to the width of your 2D display, or number of frequency bars to plot\nwidth = 16\nheight = pixelCount / width\n\n// Set the hue, saturation, and value for peak value indicators.\n// E.g. For white peaks, set peakHSV[1] = 0. No peaks, set peakHSV[2] = 0\npeakHSV = array(3)  // [h, s, v]\npeakHSV[0] = 0; peakHSV[1] = 1; peakHSV[2] = 1\n\n\n// Get frequency information from the sensor expansion board\nexport var frequencyData = array(32)\n// Start with an impossible value to detect if the sensor board is connected\nexport var light = -1 \n\n// Peak values for each bar, in the range 0..`height`\npeaks = array(width)\n// Current frequency values for each bar, in the range 0..`height`\nfy = array(width)     \npeakDropMs = 0  // This will accumulate `delta` to drop our peaks by a pixel\n\n// Automatic gain / PI controller. See comments in \"sound - blinkfade\".\ntargetMax = .9       // Aim for a maximum bar of 90% full\n// Approx rolling average of the maximum bar, for feedback into the PIController\naverageMax = 0\npic = makePIController(.25, 1.8, 30, 0, 100)\n\nfunction makePIController(kp, ki, start, min, max) {\n  var pic = array(5)\n  pic[0] = kp\n  pic[1] = ki\n  pic[2] = start\n  pic[3] = min\n  pic[4] = max\n  return pic\n}\n\nfunction calcPIController(pic, err) {\n  pic[2] = clamp(pic[2] + err, pic[3], pic[4])\n  return pic[0] * err + pic[1] * pic[2]\n}\n\n\nexport function beforeRender(delta) {\n  // Calculate sensitivity based on how far away we are from our target maximum\n  sensitivity = max(1, calcPIController(pic, targetMax - averageMax))\n\n  hueT = time(1 / 65.536)  // 1 second hue rotation\n  \n  peakDropMs += delta\n\n  // Drop all the peaks every 100ms\n  if (peakDropMs > 100) {\n    peakDropMs = 0\n    for (i = 0; i < width; i++) peaks[i] -= 1\n  }\n\n  if (light == -1) simulateSound() // `light` is >= 0 if the SB is connected\n  \n  currentMax = 0\n  for (i = 0; i < width; i++) {\n    logy = log(i / width + 1) // Plot lower bins (log of 2 = bottom 30%)\n    // Determine the portion of the bar filled based on the current sound level.\n    // We use the PIController sensitivity to try and keep this at the targetMax\n    powerLevel = frequencyData[logy * 32] * sensitivity\n    fy[i] = floor(min(1, powerLevel) * height)\n    peaks[i] = max(peaks[i], fy[i] - 1)\n\n    currentMax = max(currentMax, powerLevel)\n  }\n  averageMax = averageMax - (averageMax / 50) + (currentMax / 50)\n}\n\nexport function render2D(index, x, y) {\n  xPixel = floor(x * width)  // Converts 0..1 'world units' x into pixel width\n  yPixel = height - 1 - floor(y * height) // Invert so baseline is yPixel == 0\n\n  h = hueT + x // Cycle the bar color through the rainbow. hsv() 'wraps' h.\n  s = 1\n  v = fy[xPixel] > yPixel  // Fill bars from 0..fy[xPixel]\n  \n  // If this is a peak pixel, apply the peakHSV color\n  if (peaks[xPixel] == yPixel) {\n    h = peakHSV[0]; s = peakHSV[1]; v = peakHSV[2]\n  }\n  \n  hsv(h, s, v)\n}\n\n// The 1D fallback plots the raw 32-bin spectrum across all pixels in a strip\nexport function render(index) {\n  h = hueT + index/pixelCount // Cycle bar color. Remember, hsv() 'wraps' h.\n  \n  // Spread all 32 bins across the strip and interpolate\n  binPixelWidth = pixelCount / 31\n  LBin = floor(index / binPixelWidth)\n  RBinPct = (index % binPixelWidth) / binPixelWidth\n  v = (1 - RBinPct) * frequencyData[LBin] + RBinPct * frequencyData[LBin + 1]\n  v *= sensitivity // Scale by PI controller's sensitivity\n\n  hsv(h, 1, v * v)\n}\n\n\n/*\n  Simulate the sensor board variables used in this pattern, if no sensor board\n  is detected. The values and waveforms were chosen to approximate the look when\n  real sound is sensed for a basic 4-on-the-floor loop.\n*/\nBPM = 120\nvar measurePeriod = 4 * 60 / BPM / 65.536\n\nfunction simulateSound() {\n  tM = time(measurePeriod) // 2 seconds per measure @120 BPM\n  tP = time(8 * measurePeriod) // 8 measures per phrase\n  for (i = 0; i < 32; i++) frequencyData[i] = 0\n  \n  beat = (-4 * tM + 5) % 1 // 4 attacks per measure\n  beat *= .02 * pow(beat, 4)  // Scale magnitude and make concave-up\n  // Splay energy out, most energy at lowest frequency bins\n  for (i = 0; i < 10; i++) frequencyData[i] += beat * (10 - i) / 10\n\n  claps = .01 * square(2 * tM - .5, .10) // \"&\" of every beat\n  for (i = 9; i < 14 + random(10); i++) \n    frequencyData[i] += claps * (.7 + .6 * random(i % 2))\n\n  highHat = .003 * square(4 * tM - .5, .05) // Beats 2 and 4\n  for (i = 20; i < 30; i++) {\n    frequencyData[i] += highHat * (.8 + random(.4)) * (i % 3 < 2)\n  }\n\n  lead = 4 + floor(16 * wander(tP))  // Wandering fundamental synth's freq bin\n  for (i = 4; i < 20; i++)\n    // Excite the fundamental and, 20% of the time, 4 bins up\n    frequencyData[i] += .005 * (lead == i || lead == (i - 4) * r(.2))\n}\n\n// Random-ish perlin-esque walk for t in 0..1, outputs 0..1\n// https://www.desmos.com/calculator/enggm6rcrm\nfunction wander(t) {\n  t *= 49.261 // Selected so t's wraparound will have continuous output\n  return (wave(t / 2) * wave(t / 3) * wave(t / 5) + wave(t / 7)) / 2\n}\n\nfunction r(p) { return random(1) < p } // Randomly true with probability p"
  },
  "preview": "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"
}